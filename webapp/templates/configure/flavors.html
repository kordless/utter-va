{% extends "base.html" %}
{% import "macros.html" as macros %}

{% block page_styles %}
    <link href="/css/configure.css" rel="stylesheet">
    <link href="/css/docs.css" rel="stylesheet">
{% endblock %}

{% block navbar %}
  {% include 'navbar.html' %}
{% endblock %}

{% block content %}
<!-- set ask rate modal -->
<div id="modal-flavor-set-ask" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">Set Ask Price</h4>
      </div>
      <div class="modal-body">
        <p>This appliance is advertising an ask price of <code><span id="appliance-flavor-ask"></span> μBTC/Hour</code> for the <strong><span id="appliance-flavor-name"></span></strong> flavor. The pool reported network rate for the flavor of <code><span id="pool-flavor-rate"></span> μBTC/Hour</code> less than 15 minutes ago.</p>
        <p>Enter an amount below and then click on <strong>Set Ask Price</strong> to set it as the new ask price.</p>
        <div class="row">
          <div class="col-md-5 form-padding" id="askrate-form">
            <label class="control-label" for="askrate">Ask Price (in μBTC/hour)</label>
            <input length=20 class="form-control" id="askrate" name="askrate" type="text">
          </div>
        </div>
        <p><strong>Note:</strong> A μBTC is one millionth of a Bitcoin. <code>10 μBTC</code> is  approximately <code>US${{ '%0.4f'| format(quote*10|float) }}</code>.</p>
      </div>
      <div class="modal-footer">
        <button type="button" id="set-ask-close-button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" id="set-ask-confirm-button" class="btn btn-danger">Set Ask Price</button>
      </div>
    </div>
  </div>
</div>
<!-- end modal -->

<div class="container content">
  <div class="row">
    {{ macros.nav_pills("systems", settings) }}
    <div class="col-md-9">
      <div class="row">
        <div class="col-md-12">
          <div class="section-header">
            <h2><small>Flavors & Ask Prices</small></h2>
            <div class="bs-callout bs-callout-info bs-callout-top">
              <h4>About Flavors</h4>
              <p><strong>Flavors</strong> are used by <strong>Appliances</strong> to describe <strong>Instance Type</strong> values for <strong># of Compute Cores</strong>, <strong>Memory</strong>, <strong>Disk</strong> and <strong>Network Speed</strong>. You can update this appliance's <strong>Ask Prices</strong> for flavors it advertises via <strong>Instance Asks</strong> by clicking on the <strong>Flavor Name</strong> link.</p>
              <p>You can install new flavors by clicking the <strong>Install a New Flavor</strong> button below.</p>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          {% if flavors %}
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Flavor</th>
                <th>Memory</th>
                <th>VPUs</th>
                <th>Disk</th>
								<th class="text-center">Ingress</th>
                <th class="text-center">Egress</th>
                <th>Ask Rate</th>
                <th>Serving</th>
              </tr>
            </thead>
            <tbody>
              {% for flavor in flavors %}
              <tr>
                <td><a href="/configure/flavors/{{flavor.id}}">{{ flavor.name }}</a></td>
                <td>{{ flavor.vpus }} Core{% if flavor.vpus > 1 %}s{% endif %}</td>
                <td>{{ flavor.memory }}MB</td>
                <td>{{ flavor.disk }}GB</td>
                <td class="text-center">{% if flavor.network_down < 0 %}<span class="glyphicon glyphicon-ban-circle"></span>{% else %}{{ flavor.network_down }}{% endif %}</td>
                <td class="text-center">{% if flavor.network_up < 0 %}<span class="glyphicon glyphicon-ban-circle"></span>{% else %}{{ flavor.network_up }} Mb/sec{% endif %}</td>
                <td>{{ flavor.ask }} μBTC/Hour <a id="ask-flavor-{{ flavor.id }}" title="Set ask for {{ flavor.name }}." data-flavor="{{ flavor.id }}" data-flavor-ask="{{ flavor.ask }}" data-flavor-rate="{{ flavor.rate }}" href="#"><span class="glyphicon glyphicon-pencil"></span></a></td>
                <td>
                  <div class="toggle-modern">
                    <div id="flavor-{{flavor.id}}" class="toggle{% if flavor.active %} enabled{% endif %}"></div>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <p><code>10 μBTC = ~US${{ '%0.6f'| format(quote*10|float) }}</code> <a href="https://coinbase.com" target="_blank">via Coinbase</a></p>
          <button id="install_flavors" class="btn btn-success">Install a New Flavor</button>
          {% else %}
          <button id="reload" class="btn btn-danger"><span class="glyphicon glyphicon-time"></span> Please wait while flavors are generated.</button>
          {% endif %}
        </div>
      </div>
    </div>
    <!-- end right side -->
  </div>
</div>
{% endblock %}

{% block javascript %}
<script type="text/javascript">
  $().ready(function() {
    var csrf_token = "{{ csrf_token() }}";

    // install button
    $('#install_flavors').click(function() {
      window.location = "{{ url_for('configure.configure_flavors_add') }}";
    });

    // warn about needing some serving
    {% if settings['flavors'] == False %}
      alertify.log("You need a minimum of one flavor enabled to serve instances.", "error");
    {% endif %}

    // toggle function
    function ajax_toggle(url, id) {
      // button state to enabled 
      enabled = $('#'+id).children('.active').length;
      $.ajax({
        url: url,
        type: 'PUT',
        data: {_csrf_token: csrf_token, enable: enabled},
        success: function() {
          var num_enabled = 0;
          $('div[id^="flavor-"]').each(function(){
            flavor_id = this.id.split("-").pop();
            if ($('#flavor-'+flavor_id).children('.active').length) {
              num_enabled = num_enabled + 1;
            }
          });
          if (num_enabled < 1){
            alertify.log("You need a minimum of one flavor enabled to serve instances.", "error");
            $('#flavors-settings').removeClass("hidden");
          } else {
            $('#flavors-settings').addClass("hidden");
          }
        }
      });
    }

    // toggle sliders
    $('div[id^="flavor-"]').each(function(index){
      $('#'+this.id).toggles({
        text: {
          on: 'ON',
          off:'OFF',
        },
        on: $(this).hasClass('enabled')
      });
      $('#'+this.id).click(function() {
        ajax_toggle('/configure/flavors/'+this.id.split("-").pop(), this.id);
      });
    });

    // flavor buttons
    $('a[id^="ask-flavor-"]').each(function(index){
      $('#'+this.id).click(function() {
        flavor_id = this.id.split("-").pop();
        $('#modal-flavor-set-ask').modal('show');
      });
    });

  });
</script>
{% endblock %}

{% block extras %}
  <script type="text/javascript" src="/js/toggles.js"></script>
  <script type="text/javascript" src="/js/popovers.js"></script>
{% endblock %}
