{% extends "base.html" %}
{% import "macros.html" as macros %}

{% block page_styles %}
    <link href="/css/configure.css" rel="stylesheet">
    <link href="/css/docs.css" rel="stylesheet">
{% endblock %}

{% block navbar %}
  {% include 'navbar.html' %}
{% endblock %}

{% block content %}
<div class="container content">
  <div class="row">
    {{ macros.nav_pills("systems", settings) }}
    <div class="col-md-9">
      <div class="row">
        <div class="col-md-12">
          <div class="section-header">
            <h2><small>Auto-generated Flavors</small></h2>
            <div class="bs-callout bs-callout-info bs-callout-top">
              <h4>About auto-generated Flavors</h4>
              <p><strong>Auto-generated Flavors</strong> are the result of a merge process that happens on the StackMonkey Pool by merging various flavors from different <strong>OpenStack installations</strong>.</p>
              <p>You can <strong>install</strong> them into your <strong>OpenStack cluster</strong> using the <strong>install</strong> button</p>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Flavor</th>
                <th>VPUs</th>
                <th>Memory</th>
                <th>Disk</th>
                <th>Network Down/Up</th>
                <th>Ask Rate</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for flavor in flavors %}
              <tr>
                <td><a href="/configure/flavors/{{flavor.id}}">{{ flavor.name }}</a></td>
                <td>{{ flavor.vpus }} Core{% if flavor.vpus > 1 %}s{% endif %}</td>
                <td>{{ flavor.memory }}MB</td>
                <td>{{ flavor.disk }}GB</td>
                <td>{% if flavor.network_down < 0 %}Unlimited{% else %}{{ flavor.network_down }}{% endif %} / {% if flavor.network_up < 0 %}Unlimited{% else %}{{ flavor.network_up }} Mb/sec{% endif %}</td>
                <td>{{ flavor.ask }} Î¼BTC/Hour</td>      
								<td>
									<div class="toggle-modern">
										<div id="flavor-install-{{flavor.id}}" class="toggle {% if flavor.locality == 3 %}installed{% endif %}"></div>
									</div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          <div class="section-header">
            <h2><small>Flavor permissions</small></h2>
            <div class="bs-callout bs-callout-info bs-callout-top">
							<p>On many <strong>OpenStack</strong> installations a normal user cannot create or delete falvors by default. In such a case <strong>StackMonkey</strong> will be <strong>unable</strong> to install a flavor unless it's <strong>OpenStack user</strong> is <strong>admin</strong>. If you don't feel comfortable making the user an <strong>admin</strong>, you can also allow the <strong>StackMonkey user</strong> to create and edit flavors by editing nova's <strong>policy.json</strong>.</p>
							<p>For <strong>Example</strong> if your the OpenStack user's id is <strong><code>12345</code></strong>, you could <strong>grant</strong> her the necessary permissions by editing the following lines in <strong><code>/etc/nova/policy.json</code></strong> to look like this:
							</p>
							<p>
								<code>
									"compute_extension:flavorextraspecs:create": "rule:admin_api or user_id:12345",<br />
									"compute_extension:flavorextraspecs:update": "rule:admin_api or user_id:12345",<br />
									"compute_extension:flavorextraspecs:delete": "rule:admin_api or user_id:12345",<br />
									"compute_extension:flavormanage": "rule:admin_api or user_id:12345",
								</code>
							</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- end right side -->
  </div>
</div>
{% endblock %}

{% block javascript %}
<script type="text/javascript">
  $().ready(function() {
    var csrf_token = "{{ csrf_token() }}";

    // install toggle
    $('div[id^="flavor-install-"]').each(function(index){

      // setup initial state and button text
      $('#'+this.id).toggles({
        text: {
          on: 'Remove',
          off: 'Install',
        },
        on: $(this).hasClass('installed')
      });

      // submit the action
      $('#'+this.id).on('toggle', function(e, active){
        if (active) {
          action = 'install';
        } else{
          action = 'uninstall';
        }
        ajax_toggle('/configure/pool_flavors/' + 
            this.id.split("-").pop() + '/' + action , this.id, action);
      });

      function ajax_toggle(url, id, action) {
        if (action == 'install') {
          msg_action = 'installed';
        } else if (action == 'uninstall') {
          msg_action = 'removed';
        }
        $.ajax({
          url: url,
          type: 'PUT',
          data: {_csrf_token: csrf_token},
          success: function(data, textStatus, jqXHR) {
            alertify.log("Flavor has been " + msg_action + ".", "info");
          },
          error: function(jqXHR, textStatus, errorThrown) {
            alertify.log(jqXHR['responseJSON']['result']['message'], "error");
          },
        });
      }
    });
  });
</script>
{% endblock %}

{% block extras %}
  <script type="text/javascript" src="/js/toggles.js"></script>
  <script type="text/javascript" src="/js/popovers.js"></script>
{% endblock %}
